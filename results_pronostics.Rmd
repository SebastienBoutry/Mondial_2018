---
title: "Résultats des pronostics"
toc: false
toc_float: false
---

```{r setup, include=FALSE,message=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE)
library(ggthemes) ; library(circlepackeR) ; library(Hmisc) ; library(tidyverse) ; library(echarts4r) ; library(magrittr) ; library(data.tree) ; library(flexdashboard) ; library(lubridate) ; suppressPackageStartupMessages(library(googleVis)) ; library(ggpubr) ; library(echarts4r) ; library(gganimate) ; library(ggpubr) ; library(tweenr) ; library(viridis) ; library(magick) ; library(animation) ; library(slickR) ; library(svglite) ; library(htmlwidgets) ; library(plotly)  ; library(formattable) ; library(kableExtra) ;
#########################################
load("data/sorties_tables/sortie.Rdata")
classement_fifa<-read.csv2("data/ClassementFifa.csv")
rep_fig = "img/figures/"
```

<br>


## Quel est votre classement ?

<br>
  
### Pronostiqueurs(s) de la journée précédente
  
  <br>
  
```{r,pronostiqueurs de la journée,echo=FALSE,warning=FALSE,message=FALSE}
table_resultats_pronostics %>%
  separate(id_match_joueur,c("id_match","pseudo"),sep="_") %>%
  left_join(table_evenements %>%
              mutate(cd_date=as.character(cd_date),
                     Heure=as.character(Heure)) %>%
              dplyr::select(id_match,cd_date,Heure),by="id_match") %>%
  # unite(datetime,c("cd_date","Heure")) %>%
  mutate(datetime=ymd(cd_date)) %>%
  mutate(datetime=ymd(cd_date)) %>%
  arrange(datetime)->pronostics

pronostics %>%
  dplyr::select(pseudo,datetime,points) %>%
  mutate(pseudo=Hmisc::capitalize(pseudo)) %>%
  group_by(pseudo,datetime) %>%
  mutate(points=sum(points)) %>%
  ungroup() %>%
  distinct() %>%
  arrange(pseudo) %>%
  group_by(pseudo) %>%
  mutate(PtsCum = cumsum(points)) %>%
  arrange(pseudo) %>%
  dplyr::select(pseudo,datetime,PtsCum) %>%
  ungroup() %>%
  as.data.frame() %>%
  distinct() ->pronostics
######################################################
pronostics %>% 
  # mutate(pseudo=tolower(pseudo)) %>% 
  filter(datetime>=unique(sort(datetime))[length(unique(sort(datetime)))-1])%>% 
  group_by(pseudo)%>% 
  summarise(Diff=diff(PtsCum)) %>% 
  arrange(desc(Diff)) %>%
  filter(Diff %in% max(Diff)) %>%
  ungroup() -> Classement_pronostiqueurs
################################################
# yo<-Classement_pronostiqueurs_ori[Classement_pronostiqueurs_ori$pseudo %in% Classement_pronostiqueurs$pseudo,]
# if(nrow(yo)>1){
#   yo<-yo %>% arrange(desc(MisEnLumiere)) #%>% slice(1)
#   Classement_pronostiqueurs %>% filter(Classement_pronostiqueurs$pseudo==yo$pseudo,] %>% 
#      mutate(
#       Score.A = color_tile("white", "green")(Score.A),
#       Score.B = color_tile("white", "green")(Score.B)) %>% 
#     rename("Score A"="Score.A","Score B"="Score.B","Equipe B"="Equipe.B","Equipe A"="Equipe.A") %>% 
#     kable(escape = F) %>%
#       # row_spec(0, angle = -45) %>% 
#     kable_styling("striped", full_width = F)
# }else{
#   Classement_pronostiqueurs_ori$MisEnLumiere[Classement_pronostiqueurs_ori$pseudo %in% Classement_pronostiqueurs$pseudo] <- Classement_pronostiqueurs_ori$MisEnLumiere[Classement_pronostiqueurs_ori$pseudo %in% Classement_pronostiqueurs$pseudo]+1
#   print(Classement_pronostiqueurs)
# }
######
# formattable(Classement_pronostiqueurs,  Diff= color_bar("lightblue"))
Classement_pronostiqueurs %>%
  # rename("Bonus de points"="Diff") %>%
  mutate(
    Diff= cell_spec(Diff,background = "red", color = "white", align = "center")) %>%
  rename("Points gagnés"="Diff") %>%
  kable(escape = F) %>%
  kable_styling("striped", full_width = F,font_size = 25,position= "float_right")
```

![Pepe](https://media1.giphy.com/media/42VdQEIJ2GnHa/200.gif?cid=e1bb72ff5b2a02826f542f666f970428)
<!-- ![Marquinhos](https://media3.giphy.com/media/l1J9Ngpd4xUTHv6aA/giphy-downsized.gif?cid=e1bb72ff5b2912ca4949497649813b65) -->


<br>
  
### Classement des pronostiqueurs
  
  <br>
  
```{r,Classement pronostiqueurs,echo=FALSE,warning=FALSE,message=FALSE, fig.align = "center"}
# table_resultats_pronostics %>%
#   separate(id_match_joueur,c("id_match","pseudo"),sep="_") %>%
#   left_join(table_evenements %>%
#               mutate(cd_date=as.character(cd_date),
#                      Heure=as.character(Heure)) %>%
#               dplyr::select(id_match,cd_date,Heure),by="id_match") %>%
#   # unite(datetime,c("cd_date","Heure")) %>%
#   mutate(datetime=ymd(cd_date)) %>%
#   mutate(datetime=ymd(cd_date)) %>%
#   arrange(datetime)->pronostics
# 
# pronostics %>%
#   dplyr::select(pseudo,datetime,points) %>%
#   mutate(pseudo=Hmisc::capitalize(pseudo)) %>%
#   group_by(pseudo,datetime) %>%
#   mutate(points=sum(points)) %>%
#   ungroup() %>%
#   distinct() %>%
#   arrange(pseudo) %>%
#   group_by(pseudo) %>%
#   mutate(PtsCum = cumsum(points)) %>%
#   arrange(pseudo) %>%
#   dplyr::select(pseudo,datetime,PtsCum) %>%
#   ungroup() %>%
#   as.data.frame() %>%
#   distinct() ->pronostics
# ######################################################
pronostics %>%
  filter(datetime==max(datetime)) %>%
  arrange((PtsCum)) %>%
  dplyr::select(pseudo) %>% pull()->levels_pseudo
########################################""

p2<-pronostics %>% 
  mutate(pseudo=factor(pseudo,levels=levels_pseudo),
         `Journée`=as.character(datetime)) %>% 
  rename("Points cumulés"="PtsCum",
         "Pseudo"="pseudo") %>% 
  ggplot(aes(x=`Points cumulés`,y=Pseudo,frame=`Journée`,col=`Points cumulés`))+
  # geom_bar(col="gray50",stat = "identity")+
  geom_point(size=3)+
  ylab("Pseudo\n (par ordre décroissant des points cumulés)")+
  xlab("Points cumulés")+
  labs(col="Points")+
  #scale_fill_viridis(option="plasma",discrete = T,direction=-1)+
  scale_color_gradientn(colours = viridis(256, option = "C",direction=-1))+
  theme_pubclean()+
  theme(axis.text=element_text(face="bold",size=12),
        strip.background = element_rect(fill="gray88", colour="indianred3",size=1),
        legend.position='none',
        strip.text=element_text(size=20,face="bold.italic",colour = "blue4"),
        axis.ticks.y=element_blank(),
        axis.title.y = element_text(size=15),
        plot.margin = unit(c(1,1,1,3), "cm"))
# Create plotly graph
ggplotly(p2, height =900, width =750) %>%
  animation_opts(frame = 1000*length(unique(pronostics$datetime)),
                 easing = "linear",
                 redraw = FALSE)
```

<br>


### Par match

On propose un focus sur seulement les matchs de la dernière journée du tournoi.

```{r,carrousel pronostics par jour,echo=FALSE,warning=FALSE,message=FALSE, fig.align = "center"}

if(nrow(table_matchs)>0){
  #####
  table_resultats_matchsA=table_matchs %>% 
    filter(cd_statut=="A") %>% 
    rename("EquipeA"="pays","scoreA"="Score") %>%
    select(id_match,EquipeA,scoreA)
  
  table_resultats_matchsB=table_matchs %>% 
    filter(cd_statut=="B") %>% 
    rename("EquipeB"="pays","scoreB"="Score") %>%
    select(id_match,EquipeB,scoreB)
  
  table_resultats_matchs = table_resultats_matchsA %>% 
    left_join(table_resultats_matchsB,by = "id_match")
  
  table_resultats_pronostics_podium = table_resultats_pronostics %>% 
    separate(id_match_joueur,c("id_match","pseudo"),sep="_") %>%
    group_by(pseudo) %>% 
    mutate(points_cum=cumsum(points)) %>% 
    mutate(points_cum_plot=as.factor(as.character(points_cum))) %>% 
    mutate(points_plot=as.factor(as.character(points))) %>% 
    left_join(table_resultats_matchs,by = "id_match" ) %>% 
    left_join(table_evenements,by = "id_match") %>% 
    select(-c(id_tour,Heure,Equipe.A, Equipe.B))
  
  
  ###### points par match ######
  
  barplot2=list()
  for (i in unique(table_resultats_pronostics_podium$id_match)){
    
    fig = list.files(path=rep_fig,pattern=i)
    
    if(length(fig>1)){}else{
      
      tab=table_resultats_pronostics_podium %>% 
        filter(id_match==i)
      
      
      EquipeA=unique(tab$EquipeA)
      EquipeB=unique(tab$EquipeB)
      scoreA=unique(tab$scoreA)
      scoreB=unique(tab$scoreB)
      date=format(as.Date(unique(tab$cd_date)),"%d/%m/%Y")
      
      tab$titre=paste(date, "\n",EquipeA," - ",EquipeB,"\n",scoreA, " - ", scoreB,sep="")
      breaks=unique(tab$points) 
      
      
      
      barplot2[[i]] = ggplot(tab,aes(x=points,y=reorder(Hmisc::capitalize(pseudo),points)))+
        geom_segment(aes(yend=reorder(Hmisc::capitalize(pseudo),points_cum)),xend=0,col="gray50")+
        geom_point(size=3,aes(col=points_plot))+
        ylab("")+
        xlab("")+
        labs(col="Points")+
        scale_color_viridis(option="plasma", discrete = T, direction = -1)+
        #scale_colour_manual(palette="Paired",direction=-1)+
        scale_x_continuous(breaks=breaks)+
        facet_wrap(~titre)+
        theme_pubclean()+
        theme(axis.text=element_text(face="bold",size=15),
              strip.background = element_rect(fill="gray88", colour="indianred3",size=1),
              legend.position='none',
              strip.text=element_text(size=20,face="bold.italic",colour = "blue4"),
              axis.ticks.y=element_blank(),
              axis.title.y = element_text(size=20,face="bold"))
      
      # print(barplot2[[i]])
      
      
      ggsave(file=paste(rep_fig,i,".png",sep=""),plot=barplot2[[i]],height =10,width=10)
    }
    
  }
  
  b<-unique(table_resultats_pronostics_podium$id_match)
  z<-sprintf("%s.png",b)
  
table_resultats_pronostics_podium %>% 
  ungroup() %>% 
  select(id_match) %>% 
  distinct() %>% 
  left_join(table_evenements,by="id_match") %>% 
  select(cd_date) %>% pull() %>% max()->date_max
table_evenements %>% 
  filter(cd_date %in% date_max) %>% 
  select(id_match) %>% pull()->id_match_sel

  
  z_sel<-sprintf("%s.png",id_match_sel)
  # s2<-if(interactive()) slickR(obj=paste(rep_fig,z,sep=""), width = '70%')
  slickR(
    obj = paste(rep_fig,z_sel,sep=""),
    slideId = c('ex2'),
    # slickOpts = list(
    #   initialSlide = 1,
    #   slidesToShow = 2,
    #   slidesToScroll = 2,
    #   focusOnSelect = T,
    #   dots = T
    # ),
    # height = '100%',
    width = 750
    )
  # saveWidget(s2, file=paste0(rep_fig,"graph_match.html"))
}else{ 
  knitr::include_graphics("img/refus.jpg")
}

```

<br>


## Avez-vous fait le bon choix ?


Lors de votre inscription, on vous a demandé l'équipe qui selon vous sera championne du monde.
<br>

### Equipes candidates au titre de Championne du monde


On vous dévoile les premiers résultats de l'enquête.  

* Sur le camembert, vous pouvez voir la répartition des pays que vous avez choisis comme gagnant pour le mondial.  
* Le diagramme en barre représente selon les tournois précédents le classement des équipes pré-sélectionnées.  

L'équipe de France a été citée 13 fois. Y-a-t-il du chauvinisme ?  
Depuis 1978, on peut voir que le Pérou n'a jamais atteint le dernier carré final de la compétition, tandis que l'Allemagne reste une valeur sûre.

<br>

```{r,graph retro,echo=FALSE,warning=FALSE,message=FALSE, fig.align = "center"}

##################################################
unaccent <- function(text){
  text <- gsub("['`^~\"]", " ", text)
  text <- iconv(text, to="ASCII//TRANSLIT//IGNORE")
  text <- gsub("['`^~\"]", "", text)
  return(text)
}
table_participants %>% group_by(champion) %>% summarise(Nbr=n()) %>% ungroup()->data_pie
classement_fifa<-classement_fifa %>%  
  rename("2022"="X2022",
         "2018"="X2018",
         "2014"="X2014",
         "2010"="X2010" ,
         "2006"="X2006","2002"="X2002",
         "1998"="X1998","1994"="X1994","1990"="X1990","1986"="X1986","1982"="X1982",
         "1978"="X1978")
classement_fifa$Equipe<-unaccent(as.character(classement_fifa$Equipe))

table_participants %>%   
  group_by(champion) %>% 
  summarise(Nbr=n()) %>% 
  ungroup() %>% 
  left_join(table_pays,by=c("champion"="pays")) %>% 
  mutate(Classement=as.integer(Classement)) %>% 
  left_join(classement_fifa,"Classement") %>% 
  select(Equipe,Classement,Nbr,`2022`,`2018`,`2014`,`2010`,`2006`,`2002`,`1998`,`1994`,`1990`,`1986`,`1982`,`1978`) %>% gather(Year,Value,`2022`,`2018`,`2014`,`2010`,`2006`,`2002`,`1998`,`1994`,`1990`,`1986`,`1982`,`1978`) %>% 
  mutate(Value=factor(ifelse(Value>0,5-Value,0),ordered = TRUE)) %>% 
  spread(Equipe,Value) %>%
  mutate(Year=factor(Year,levels=seq(1978,2022,4))) %>% 
  arrange(Year) %>% 
  e_charts(Year,width="100%") %>% 
  e_bar(Allemagne) %>% 
  e_bar(Angleterre) %>% 
  e_bar(Argentine) %>% 
  e_bar(Belgique) %>% 
  e_bar(Bresil) %>% 
  e_bar(Espagne) %>% 
  e_bar(France) %>% 
  e_bar(Perou) %>% 
  e_bar(Portugal) %>% 
  e_data(data_pie, champion) %>% 
  e_pie(Nbr, rm.x = FALSE, rm.y = FALSE, center = c("85%", "50%"), radius = c(0, 30)) %>% 
  e_tooltip(trigger = "item") %>% 
  e_title("Rétrospective selon les Mondiaux","des équipes sélectionnées par les pronostiqueurs\n et occurences",right="right") %>% 
  e_theme("infographic") %>% 
  e_legend(bottom = 0) %>% # move legend to the bottom
  e_x_axis(name="Année de\ncoupe\ndu monde",axisLabel = list(interval = 0, rotate = 45)) %>% 
  e_y_axis(name="Classement dans\n le dernier carré\n(4=Champion, ..., 1=4eme)",show=TRUE,axisLabel = list(interval = 0)) 
```

<br>






<!-- <br> -->

<!-- ```{r,graph pronostics,results='asis', cache=TRUE, warning=FALSE,message=FALSE}  -->
<!-- ###################################################### -->
<!-- table_resultats_pronostics %>%  -->
<!--   separate(id_match_joueur,c("id_match","pseudo"),sep="_") %>%  -->
<!--   left_join(table_evenements %>%  -->
<!--               mutate(cd_date=as.character(cd_date), -->
<!--                      Heure=as.character(Heure)) %>%  -->
<!--               select(id_match,cd_date,Heure),by="id_match") %>%  -->
<!--   # unite(datetime,c("cd_date","Heure")) %>% -->
<!--   mutate(datetime=ymd(cd_date)) %>%  -->
<!--    mutate(datetime=ymd(cd_date)) %>%  -->
<!--   arrange(datetime)->pronostics -->

<!-- pronostics %>%  -->
<!--   select(pseudo,datetime,points) %>%  -->
<!--   group_by(pseudo,datetime) %>%  -->
<!--   mutate(points=sum(points)) %>%  -->
<!--   ungroup() %>%   distinct() %>%  -->
<!--   arrange(pseudo) %>%  -->
<!--   group_by(pseudo) %>%  -->
<!--   mutate(PtsCum = cumsum(points)) %>%  -->
<!--   arrange(pseudo) %>%  -->
<!--   select(pseudo,datetime,PtsCum) %>%   -->
<!--   ungroup() %>%   -->
<!--   as.data.frame() %>%  -->
<!--   distinct() ->pronostics -->

<!-- M<-gvisMotionChart(pronostics, idvar='pseudo', timevar='datetime',options=list(showYMetricPicker=F,showXMetricPicker=F,showAdvancedPanel=F))   -->
<!-- print(M,"chart") -->
<!-- ``` -->

<!-- <br> -->


